<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kala Residency UPI Payment</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: system-ui, Roboto, sans-serif; background: linear-gradient(135deg,#667eea 0,#764ba2 100%); padding:20px; display:flex; justify-content:center; align-items:center; min-height:100vh; color:#222; }
    .container { width:100%; max-width:540px; background:#fff; padding:28px; border-radius:18px; box-shadow:0 20px 50px rgba(0,0,0,0.25); position:relative; }
    .header { text-align:center; margin-bottom:20px; }
    .logo { width:72px; height:72px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:28px; background:linear-gradient(135deg,#667eea,#764ba2); box-shadow:0 6px 18px rgba(102,126,234,0.35); margin-bottom:10px; }
    h2 { margin-bottom:4px; font-size:20px; }
    .subtitle { color:#666; font-size:13px; }
    form .form-group { margin-bottom:16px; }
    label { display:block; font-weight:600; margin-bottom:6px; font-size:14px; }
    select,input { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #e6e6e6; background:#fafafa; font-size:14px; }
    button.primary { width:100%; padding:12px; border-radius:10px; border:none; background:linear-gradient(135deg,#667eea,#764ba2); color:white; font-weight:700; cursor:pointer; }
    .success { display:none; padding:12px; border-radius:10px; background:linear-gradient(135deg,#11998e,#38ef7d); color:#fff; margin-bottom:12px; text-align:center; font-weight:700; }
    .warning { display:none; padding:12px; border-radius:10px; background:linear-gradient(135deg,#fc4a1a,#f7b733); color:#fff; margin-bottom:12px; text-align:center; font-weight:700; }
    .info { display:none; padding:12px; border-radius:10px; background:linear-gradient(135deg,#2196F3,#21CBF3); color:#fff; margin-bottom:12px; text-align:center; font-weight:700; }
    #qrSection { display:none; margin-top:20px; }
    
    .qr-container { 
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      text-align: center;
    }
    .qr-header {
      background-color: #007bff;
      color: white;
      padding: 15px;
      margin: -16px -16px 20px -16px;
    }
    .qr-header h3 {
      margin: 0;
      font-size: 1.5em;
    }
    .qr-header p {
      font-size: 0.8em;
      margin: 5px 0 0 0;
    }
    .payment-details {
      text-align: left;
      margin-bottom: 20px;
      border: 1px solid #00aaff;
      padding: 15px;
      border-radius: 4px;
      background-color: #e6f7ff;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 0.9em;
    }
    .detail-label {
      font-weight: bold;
      color: #333;
    }
    .detail-value {
      color: #00aaff;
      font-weight: bold;
    }
    #qrImage {
      display: block;
      margin: 0 auto;
      border: 2px solid #ccc;
      padding: 10px;
      background-color: #fff;
      max-width: 100%;
      height: auto;
    }
    .bullet-box {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      font-size: 13px;
      line-height: 1.4;
    }
    .bullet-point {
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
    }
    .bullet-point:last-child {
      margin-bottom: 0;
    }
    .bullet-point::before {
      content: "‚Ä¢";
      margin-right: 8px;
      font-weight: bold;
    }
    .actions { display:flex; gap:10px; margin-top:12px; }
    .btn { flex:1; padding:10px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    .btn.green { background:linear-gradient(135deg,#11998e,#38ef7d); color:#fff; }
    .footer-note {
      font-size: 0.7em;
      margin-top: 20px;
      color: #666;
      text-align: center;
    }
    .nav-links {
      text-align: center;
      margin-top: 20px;
    }
    .nav-links a {
      color: #667eea;
      text-decoration: none;
      margin: 0 10px;
      font-weight: 600;
    }
    .nav-links a:hover {
      text-decoration: underline;
    }
    @media (max-width:520px){ .container{padding:18px;} #qrImage{width:220px;height:220px;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">KR</div>
      <h2>Kala Residency</h2>
      <div class="subtitle">Secure Online Payment System</div>
    </div>

    <div id="successMessage" class="success">‚úì Payment QR Generated Successfully!</div>
    <div id="warningMessage" class="warning"></div>
    <div id="infoMessage" class="info"></div>

    <form id="payForm">
      <div class="form-group">
        <label>Flat/Shop Number</label>
        <select id="flat" required>
          <option value="">Select your flat/shop</option>
          <option value="Flat 1">Flat 1</option>
          <option value="Flat 2">Flat 2</option>
          <option value="Flat 3">Flat 3</option>
          <option value="Flat 4">Flat 4</option>
          <option value="Flat 5">Flat 5</option>
          <option value="Flat 6">Flat 6</option>
          <option value="Flat 7">Flat 7</option>
          <option value="Flat 8">Flat 8</option>
          <option value="Flat 9">Flat 9</option>
          <option value="Flat 10">Flat 10</option>
          <option value="Flat 11">Flat 11</option>
          <option value="Flat 12">Flat 12</option>
          <option value="Flat 13">Flat 13</option>
          <option value="Flat 14">Flat 14</option>
          <option value="Flat 15">Flat 15</option>
          <option value="Flat 16">Flat 16</option>
          <option value="Flat 17">Flat 17</option>
          <option value="Flat 18">Flat 18</option>
          <option value="Flat 19">Flat 19</option>
          <option value="Flat 20">Flat 20</option>
          <option value="Flat 21">Flat 21</option>
          <option value="Shop 1">Shop 1</option>
          <option value="Shop 2">Shop 2</option>
          <option value="Shop 3">Shop 3</option>
          <option value="Shop 4">Shop 4</option>
          <option value="Shop 5">Shop 5</option>
        </select>
      </div>

      <div class="form-group">
        <label>Full Name</label>
        <input id="userName" type="text" placeholder="Enter your name" required />
      </div>

      <div class="form-group">
        <label>Payment Month</label>
        <input id="month" type="month" required />
      </div>

      <div class="form-group">
        <label>Amount (‚Çπ)</label>
        <input id="amount" type="number" min="1" placeholder="Enter amount" required />
      </div>

      <div class="form-group">
        <label>Payment Purpose</label>
        <select id="purpose" required>
          <option>Maintenance</option>
          <option>Water Charges</option>
          <option>Parking</option>
          <option>Sinking Fund</option>
          <option>Other</option>
        </select>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button id="generateBtn" class="primary" type="submit">Generate Payment QR Code</button>
      </div>
    </form>

    <div id="qrSection">
      <div class="qr-container">
        <div class="qr-header">
          <h3>Kala Residency</h3>
          <p>Secure & Verified Online Payment System</p>
        </div>

        <img id="qrImage" alt="Payment QR Code" src="" width="250" height="250">
        
        <div class="payment-details">
          <h3 style="text-align: center; color: #00aaff; margin-top: 0;">Payment Details</h3>
          <div class="detail-row"><span class="detail-label">Flat No / Shop</span> <span class="detail-value" id="qrFlat">-</span></div>
          <div class="detail-row"><span class="detail-label">Name</span> <span class="detail-value" id="qrName">-</span></div>
          <div class="detail-row"><span class="detail-label">Amount</span> <span class="detail-value" id="qrAmount">-</span></div>
          <div class="detail-row"><span class="detail-label">Purpose</span> <span class="detail-value" id="qrPurpose">-</span></div>
          <div class="detail-row"><span class="detail-label">Month</span> <span class="detail-value" id="qrMonth">-</span></div>
          <div class="detail-row"><span class="detail-label">Payment ID</span> <span class="detail-value" id="qrPaymentId">-</span></div>
        </div>

        <div class="bullet-box">
          <div class="bullet-point">üì¢ ‡§Æ‡§π‡§§‡•ç‡§µ‡§æ‡§ö‡•á ‡§∏‡•Ç‡§ö‡§®‡§æ: ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§®‡§Ç‡§§‡§∞, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§∞‡§∏‡•Ä‡§¶ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü ‡§ï‡§≤‡§æ ‡§∞‡•á‡§∏‡§ø‡§°‡•á‡§®‡•ç‡§∏‡•Ä‡§ö‡•ç‡§Ø‡§æ WhatsApp ‡§ó‡•ç‡§∞‡•Å‡§™ ‡§µ‡§∞ ‡§∂‡•á‡§Ö‡§∞ ‡§ï‡§∞‡§£‡•á ‡§µ‡§ø‡§∏‡§∞‡•Ç ‡§®‡§ï‡§æ</div>
          <div class="bullet-point">‡§π‡§æ QR ‡§´‡§ï‡•ç‡§§ ‡§è‡§ï‡§¶‡§æ‡§ö ‡§µ‡§æ‡§™‡§∞‡§æ ‚Äî ‡§™‡•Å‡§¢‡•Ä‡§≤ ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§µ‡•á‡§≥‡•Ä ‡§ö‡•Å‡§ï‡•Ä‡§ö‡•Ä ‡§è‡§®‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§ü‡§æ‡§≥‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§µ‡§æ‡§™‡§∞‡§≤‡•ç‡§Ø‡§æ‡§®‡§Ç‡§§‡§∞ ‡§Ü‡§™‡§≤‡•ç‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§ó‡•Ö‡§≤‡§∞‡•Ä‡§Æ‡§ß‡•Ç‡§® Delete ‡§ï‡§∞‡§æ</div>
        </div>

        <div class="actions">
          <button id="downloadQR" class="btn green">‚¨á Download QR</button>
        </div>

        <p class="footer-note">Generated by Kala Residency Online Payment System</p>
      </div>
    </div>

<script>
const TOKEN = "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E";
const REPO_OWNER = "dkapoore";
const REPO_NAME = "Kala_UPI";
const FILE_PATH = "data.json";

const UPI_PA = "9766893279@kotak811";
const UPI_PN = "DEVENDRA KAPOORE";
const UPI_CU = "INR";

let currentPaymentId = null;

const fallbackOwners = {
  "Flat 1": "BAGUL", "Flat 2": "GAYDHANI", "Flat 3": "GAIKWAD", "Flat 4": "MEHENDALE", 
  "Flat 5": "GAIKWAD", "Flat 6": "DABHADE", "Flat 7": "Khandgune", "Flat 8": "S SHARMA", 
  "Flat 9": "BANCHHODE", "Flat 10": "KARCHE", "Flat 11": "SAPKAL", "Flat 12": "DUGDHE", 
  "Flat 13": "ZOPE", "Flat 14": "WAGHMARE", "Flat 15": "JOGI", "Flat 16": "BHAVSAR", 
  "Flat 17": "B PATIL", "Flat 18": "V PATIL", "Flat 19": "KAPOORE", "Flat 20": "SHARMA", 
  "Flat 21": "KHANDARE", "Shop 1": "SHOP 1", "Shop 2": "SHOP 2", "Shop 3": "SHOP 3", 
  "Shop 4": "SHOP 4", "Shop 5": "SHOP 5"
};

document.getElementById('month').value = new Date().toISOString().slice(0,7);

document.getElementById('flat').addEventListener('change', (e) => {
  const flat = e.target.value;
  const nameInput = document.getElementById('userName');
  if (flat && fallbackOwners[flat]) {
    nameInput.value = fallbackOwners[flat];
  } else {
    nameInput.value = '';
  }
});

function capWords(s) {
  return s.split(' ').map(w => w ? (w[0].toUpperCase()+w.slice(1).toLowerCase()) : '').join(' ');
}

function buildUpiLink({amount, note}) {
  return `upi://pay?pa=${encodeURIComponent(UPI_PA)}&pn=${encodeURIComponent(UPI_PN)}&am=${encodeURIComponent(amount)}&cu=${encodeURIComponent(UPI_CU)}&tn=${encodeURIComponent(note)}`;
}

async function fetchData() {
  const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${FILE_PATH}`;
  const response = await fetch(url);
  if (!response.ok) {
    return [];
  }
  return await response.json();
}

async function saveData(data) {
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
  
  const currentFileResponse = await fetch(url, {
    headers: {
      'Authorization': `token ${TOKEN}`,
      'Accept': 'application/vnd.github.v3+json'
    }
  });
  
  let sha = null;
  if (currentFileResponse.ok) {
    const currentFile = await currentFileResponse.json();
    sha = currentFile.sha;
  }
  
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
  
  const response = await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${TOKEN}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: `Add payment record: ${new Date().toISOString()}`,
      content: content,
      sha: sha
    })
  });

  return response.ok;
}

async function checkDuplicate(flat, month) {
  try {
    const existingData = await fetchData();
    return existingData.some(item => item.flat === flat && item.month === month);
  } catch (e) {
    console.log('Duplicate check failed:', e);
    return false;
  }
}

function showMessage(elementId, message) {
  const element = document.getElementById(elementId);
  element.textContent = message;
  element.style.display = 'block';
  setTimeout(() => {
    element.style.display = 'none';
  }, 5000);
}

document.getElementById('payForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const flat = document.getElementById('flat').value.trim();
  let name = document.getElementById('userName').value.trim();
  name = capWords(name);
  document.getElementById('userName').value = name;
  const month = document.getElementById('month').value;
  const amount = document.getElementById('amount').value;
  const purpose = document.getElementById('purpose').value;

  if (!flat || !name || !month || !amount) {
    alert("Please fill all required fields.");
    return;
  }

  const exists = await checkDuplicate(flat, month);
  if (exists) {
    alert(`Payment for ${flat} for month ${month} already exists. If this is a correction, please contact secretary.`);
    return;
  }

  currentPaymentId = `KRP${Date.now().toString().slice(-6)}`;

  document.getElementById('qrFlat').textContent = flat;
  document.getElementById('qrName').textContent = name;
  document.getElementById('qrAmount').textContent = "‚Çπ" + amount;
  document.getElementById('qrMonth').textContent = month;
  document.getElementById('qrPurpose').textContent = purpose;
  document.getElementById('qrPaymentId').textContent = currentPaymentId;

  const note = `${flat} - ${name} - ${month} - ${purpose} - ${currentPaymentId}`;
  const upi = buildUpiLink({ amount, note });

  document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upi)}`;

  document.getElementById('qrSection').style.display = "block";
  showMessage('successMessage', '‚úì Payment QR Generated Successfully!');

  document.getElementById('qrSection').scrollIntoView({ behavior: 'smooth' });

  const existingData = await fetchData();
  const newRecord = { 
    flat, 
    name, 
    month, 
    amount: parseInt(amount), 
    purpose, 
    paymentId: currentPaymentId,
    timestamp: new Date().toISOString()
  };
  
  existingData.push(newRecord);
  await saveData(existingData);
});

document.getElementById('downloadQR').addEventListener('click', async () => {
  const flat = document.getElementById('qrFlat').textContent;
  const name = document.getElementById('qrName').textContent;
  const amount = document.getElementById('qrAmount').textContent.replace('‚Çπ','') || '0';
  const month = document.getElementById('qrMonth').textContent;
  const purpose = document.getElementById('qrPurpose').textContent;
  const paymentId = document.getElementById('qrPaymentId').textContent;
  
  if (!flat) return alert('Please generate the QR first.');

  const note = `${flat} - ${name} - ${month} - ${purpose} - ${paymentId}`;
  const upi = buildUpiLink({ amount, note });
  
  const a = document.createElement('a');
  a.href = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upi)}`;
  a.download = `Kala_Residency_QR_${flat}_${month}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});
</script>
</body>
</html>
